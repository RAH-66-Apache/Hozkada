{%load static%}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../static/media/nav_ico.png" type="image/png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Koulen">
    <link rel="stylesheet" href="../static/bokatak.css">
    <title>Hozkada-Bokatak</title>
</head>

<body>
    <div id="filtromenu">
        <div id="filtrocontent">
            <div class="dropdown">
                <p>Motak</p>
                <div class="dropdown-content">
                    <div class="checkbox-motak">
                        <div>
                            <label><input type="checkbox" name="haragia"><img
                                    src="../static/media/bokatak_img/motak/ico_haragia.png" class="ico_motak" alt="">
                                Haragia</label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="arraina"><img
                                    src="../static/media/bokatak_img/motak/ico_arraina.png" class="ico_motak" alt="">
                                Arraina</label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="begetarianoa"><img
                                    src="../static/media/bokatak_img/motak/ico_begetarianoa.png" class="ico_motak"
                                    alt=""> Begetarianoa</label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="beganoa"><img
                                    src="../static/media/bokatak_img/motak/ico_beganoa.png" class="ico_motak" alt="">
                                Beganoa</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dropdown">
                <p>Alergiak</p>
                <div class="dropdown-content">
                    <div class="checkbox-alergiak">
                        <div>
                            <label><input type="checkbox" name="Glutena"> Glutena<img
                                    src="../static/media/bokatak_img/alergiak/ico_gluten.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Arrautzak"> Arrautzak<img
                                    src="../static/media/bokatak_img/alergiak/ico_arrautzak.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Arrainak"> Arrainak<img
                                    src="../static/media/bokatak_img/alergiak/ico_arrainak.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Krustazeoak"> Krustazeoak<img
                                    src="../static/media/bokatak_img/alergiak/ico_krustazeo.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Moluskoak"> Moluskoak<img
                                    src="../static/media/bokatak_img/alergiak/ico_gluten.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Frutu lehorrak"> Frutu Lehorrak<img
                                    src="../static/media/bokatak_img/alergiak/ico_fruitulehorrak.png"
                                    class="ico_alergiak" alt=""></label>
                        </div>
                        <div>
                            <label><input type="checkbox" name="Soja"> Soja<img
                                    src="../static/media/bokatak_img/alergiak/ico_soja.png" class="ico_alergiak"
                                    alt=""></label>
                        </div>
                    </div>
                </div>
            </div>
            <p>Deskontuak</p>
        </div>
    </div>
    </div>

    <div id="content">
        <div id="bokatacontent">
            {% for bokatak in bokatak %}
            <div class="bokata" data-mota="{{ bokatak.mota }}">
                <div class="bokataimg">
                    <img src="{{ bokatak.img.url }}" alt="{{ bokatak.izena }}">
                </div>
                <div class="bokatainfo">
                    <h2 class="bokatatitulo">{{ bokatak.izena }} - <span class="prezioa">{{ bokatak.prezioa }}€</span>
                    </h2>
                    <p>{{ bokatak.deskribapena }}</p>
                    <div class="alergiak">
                        {% for alergia_platerrak in bokatak.alergia_platerra_set.all %}
                        <div data-alergia="{{alergia_platerrak.alergia_id.izena}}">
                            <img src="{{ alergia_platerrak.alergia_id.img.url }}"
                                alt="{{alergia_platerrak.alergia_id.izena}}">
                        </div>
                        {% endfor %}
                    </div>
                    {% csrf_token %}
                    <input class="karritoa-gehitu-inp" type="button" value="Karritoa gehitu"
                        data-platerra-id="{{ bokatak.id }}">
                    <div class="mesedez-ezabatu" style="display: none;"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>


    <div id="karrito">
        <div id="karritocontent">
            <p class="karritotitulo">zure produktuak</p>
            <div id="karritoerosketak">
                {% csrf_token %}
                <div id="lista-carrito">
                    <!-- Los elementos del carrito se mostrarán aquí dinámicamente -->
                </div>
            </div>
            <input id="eskatu" type="button" value="eskatu">
        </div>
    </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        function actualizarFiltros() {
            const checkboxesMotak = Array.from($('.checkbox-motak input[type="checkbox"]:checked')).map(checkbox => $(checkbox).attr('name'));
            const checkboxesAlergiak = Array.from($('.checkbox-alergiak input[type="checkbox"]:checked')).map(checkbox => $(checkbox).attr('name'));
            const productos = Array.from($('.bokata'));

            productos.forEach(producto => {
                const mota = $(producto).data("mota");
                const alergiasProducto = Array.from($(producto).find('.alergiak div')).map(alergia => $(alergia).data("alergia"));
                let productoVisible = true;

                if (checkboxesMotak.length > 0 && !checkboxesMotak.includes(mota)) {
                    productoVisible = false;
                }

                checkboxesAlergiak.forEach(function (alergia) {
                    if (alergiasProducto.includes(alergia)) {
                        productoVisible = false;
                    }
                });

                if (productoVisible) {
                    $(producto).show();
                } else {
                    $(producto).hide();
                }
            });
        }

        $(document).ready(function () {
            $('.checkbox-motak input[type="checkbox"]').change(function () {
                actualizarFiltros();
            });

            $('.checkbox-alergiak input[type="checkbox"]').change(function () {
                actualizarFiltros();
            });

            actualizarFiltros();

            var edariakcheckbox = $("#edariakcheckbox");
            var karritoedariak = $("#karritoedariak");

            karritoedariak.hide();

            // Agrega un controlador de eventos al cambio en la casilla de verificación
            edariakcheckbox.change(function () {
                // Verifica el estado actual de la casilla de verificación
                if (edariakcheckbox.is(":checked")) {
                    // Si está marcada, muestra el div con una animación
                    karritoedariak.show();
                } else {
                    // Si no está marcada, oculta el div con una animación
                    karritoedariak.hide();
                }
            });
        });


        $(document).ready(function() {
    console.log("Documento listo");
    mostrarListaCarrito();
    $(".karritoa-gehitu-inp").click(function() {
        var platerra_id = $(this).data("platerra-id");
        var bokataDiv = $(this).closest(".bokata");

        $.ajax({
            type: "POST",
            url: "/bokatak/agregar_bocata_al_carrito/" + platerra_id + "/",
            data: {
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                platerra_id: platerra_id
            },
            success: function(data) {
                if (data.success) {
                    bokataDiv.find(".mesedez-ezabatu").text("Platera gehitu da zure karritora.");
                    bokataDiv.find(".mesedez-ezabatu").show();
                    // Luego, actualiza la lista de Platerra en el carrito
                    mostrarListaCarrito();
                }
            }
        });
    });

    function mostrarListaCarrito() {
    $.ajax({
        type: "GET",
        url: "/bokatak/lista_carrito/",
        success: function(data) {
            $("#lista-carrito").empty();
            var totalPrecio = 0;

            data.carrito_data.forEach(function(platerra) {
                var subtotal = platerra.kantitatea * platerra.prezioa;
                totalPrecio += subtotal;

                // Actualiza el precio en tiempo real
                var precioActualizado = platerra.kantitatea * platerra.prezioa;
                $("#lista-carrito").append(`
                <li>
        <span class="platerra-nombre">${platerra.izena}</span>
        <span class="cantidad-precio">
            <input type="number" class="cantidad-input" value="${platerra.kantitatea}" min="1">
            x ${platerra.prezioa}€ = ${subtotal}€
            <button class="eliminar-del-carrito" data-platerra_eskaera_id="{{ platerra_eskaera.id }}">Eliminar</button>

          
        </span>
    </li>
        `);
       
            });

            // Asigna el evento de click después de agregar todos los elementos al carrito
            asignarEventoEliminar();

            // Muestra el total al final
            $("#lista-carrito").append(`
                <li>
                    <span class="total">Total: ${totalPrecio}€</span>
                </li>
            `);

            console.log("Lista de carrito actualizada con éxito");
        }
    });
}

});

$(document).on('change', '.cantidad-input', function() {
    var platerra_nombre = $(this).closest('li').find('.platerra-nombre').text().trim();
    var nueva_cantidad = $(this).val();

    $.ajax({
        type: "POST",
        url: "/bokatak/actualizar_cantidad/",
        data: {
            csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
            platerra_nombre: platerra_nombre,
            nueva_cantidad: nueva_cantidad
        },
        success: function(data) {
            if (data.success) {
                console.log("Cantidad actualizada con éxito");
                // Actualiza la lista de Platerra en el carrito con el nuevo subtotal
                mostrarListaCarrito();
            } else if (data.redirect) {
                // Redirect to the login page
                window.location.href = data.redirect;
            }
        }
    });
});
        
function asignarEventoEliminar() {
    $(".eliminar-del-carrito").off('click').on('click', function() {
        var platerra_eskaera_id = $(this).data("platerra_eskaera_id");
        console.log("Platerra Eskaera ID:", platerra_eskaera_id);

        // Añade este console.log para asegurarte de que el ID se está recuperando correctamente
        console.log("Antes de la llamada AJAX, Platerra Eskaera ID:", platerra_eskaera_id);

        // Verifica que el ID no sea 'undefined' antes de hacer la solicitud
        if (platerra_eskaera_id !== 'undefined') {
            $.ajax({
                type: "POST",
                url: "{% url 'eliminar_del_carrito' %}",
                data: {
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                    platerra_eskaera_id: platerra_eskaera_id
                },
                success: function(data) {
                    if (data.success) {
                        console.log("Platerra eliminado del carrito con éxito");
                        // Actualiza la lista de Platerra en el carrito
                        mostrarListaCarrito();
                    } else {
                        console.error("Error al intentar eliminar el Platerra del carrito");
                    }
                }
            });
        } else {
            console.error("ID de Platerra Eskaera no válido");
        }
    });
}

    </script>
</body>

</html>